<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tabla Citas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîç Debug Tabla de Citas</h1>
        
        <div class="debug-info">
            <h5>Estado de Carga</h5>
            <div id="loadingStatus">Iniciando...</div>
        </div>
        
        <div class="debug-info">
            <h5>Datos Raw del Backend</h5>
            <pre id="rawData" style="max-height: 200px; overflow-y: auto;"></pre>
        </div>
        
        <div class="debug-info">
            <h5>Datos de Pacientes</h5>
            <pre id="pacientesData" style="max-height: 150px; overflow-y: auto;"></pre>
        </div>
        
        <div class="debug-info">
            <h5>Datos de M√©dicos</h5>
            <pre id="medicosData" style="max-height: 150px; overflow-y: auto;"></pre>
        </div>
        
        <div class="debug-info">
            <h5>Tabla HTML Generado</h5>
            <pre id="htmlGenerated" style="max-height: 200px; overflow-y: auto;"></pre>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Tabla de Citas</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Paciente</th>
                            <th>M√©dico</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="citasTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        let pacientesData = [];
        let medicosData = [];
        let citasData = [];
        
        async function debugLoad() {
            const statusDiv = document.getElementById('loadingStatus');
            
            try {
                statusDiv.innerHTML = 'üîÑ Cargando pacientes...';
                pacientesData = await AppUtils.getAll('pacientes');
                document.getElementById('pacientesData').textContent = JSON.stringify(pacientesData, null, 2);
                
                statusDiv.innerHTML = 'üîÑ Cargando m√©dicos...';
                medicosData = await AppUtils.getAll('medicos');
                document.getElementById('medicosData').textContent = JSON.stringify(medicosData, null, 2);
                
                statusDiv.innerHTML = 'üîÑ Cargando citas...';
                citasData = await AppUtils.getAll('citas');
                document.getElementById('rawData').textContent = JSON.stringify(citasData, null, 2);
                
                statusDiv.innerHTML = 'üîÑ Generando tabla...';
                generateTable();
                
                statusDiv.innerHTML = '‚úÖ Completado';
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }
        
        function formatTableRow(cita) {
            const estadoClass = {
                'PROGRAMADA': 'bg-warning',
                'CONFIRMADA': 'bg-info',
                'EN_CURSO': 'bg-primary',
                'COMPLETADA': 'bg-success',
                'CANCELADA': 'bg-danger',
                'NO_ASISTIO': 'bg-secondary'
            };

            // Buscar nombre del paciente
            const paciente = pacientesData.find(p => p.id === cita.idPaciente);
            const nombrePaciente = paciente ? `${paciente.nombres} ${paciente.apellidos}` : `ID: ${cita.idPaciente}`;

            // Buscar nombre del m√©dico
            const medico = medicosData.find(m => m.id === cita.idMedico);
            const nombreMedico = medico ? `${medico.nombres} ${medico.apellidos}` : `ID: ${cita.idMedico}`;

            // Separar fecha y hora del fechaCita
            let fecha = 'N/A';
            let hora = 'N/A';
            if (cita.fechaCita) {
                const fechaHora = new Date(cita.fechaCita);
                fecha = fechaHora.toLocaleDateString('es-ES');
                hora = fechaHora.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
            }

            console.log('üîç Debug cita:', {
                cita: cita,
                paciente: paciente,
                medico: medico,
                nombrePaciente: nombrePaciente,
                nombreMedico: nombreMedico,
                fecha: fecha,
                hora: hora
            });

            const html = `
                <tr>
                    <td>${cita.id}</td>
                    <td>${nombrePaciente}</td>
                    <td>${nombreMedico}</td>
                    <td>${fecha}</td>
                    <td>${hora}</td>
                    <td><span class="badge ${estadoClass[cita.estado] || 'bg-secondary'}">${cita.estado || 'N/A'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            return html;
        }
        
        function generateTable() {
            const tbody = document.getElementById('citasTableBody');
            let allHtml = '';
            
            citasData.forEach(cita => {
                const rowHtml = formatTableRow(cita);
                allHtml += rowHtml;
            });
            
            document.getElementById('htmlGenerated').textContent = allHtml;
            tbody.innerHTML = allHtml;
        }
        
        // Cargar datos al inicializar
        document.addEventListener('DOMContentLoaded', debugLoad);
    </script>
</body>
</html>
