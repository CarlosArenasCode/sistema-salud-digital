<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test CRUD Complete</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>üß™ Test CRUD Completo - Sistema Corregido</h1>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Estado del Sistema</h3>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus" class="mb-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <span class="ms-2">Verificando estado del sistema...</span>
                        </div>
                        
                        <div id="testResults" class="row" style="display: none;">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üë• Pacientes</h5>
                                        <p id="pacientesCount" class="card-text display-4">0</p>
                                        <button id="testCreatePaciente" class="btn btn-sm btn-success">Crear Prueba</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üë®‚Äç‚öïÔ∏è M√©dicos</h5>
                                        <p id="medicosCount" class="card-text display-4">0</p>
                                        <button id="testCreateMedico" class="btn btn-sm btn-success">Crear Prueba</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üìÖ Citas</h5>
                                        <p id="citasCount" class="card-text display-4">0</p>
                                        <button id="testCreateCita" class="btn btn-sm btn-success">Crear Prueba</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üíä Medicamentos</h5>
                                        <p id="medicamentosCount" class="card-text display-4">0</p>
                                        <button id="testCreateMedicamento" class="btn btn-sm btn-success">Crear Prueba</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Log de Operaciones</h3>
                    </div>
                    <div class="card-body">
                        <div id="operationLog" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 300px; overflow-y: auto;">
                            <div class="text-muted">Esperando operaciones...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let logElement = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-primary'
            }[type] || 'text-dark';
            
            const logEntry = `<div class="${color}">[${timestamp}] ${message}</div>`;
            logElement.innerHTML += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            logElement = document.getElementById('operationLog');
            logElement.innerHTML = '';
            
            log('üöÄ Iniciando verificaci√≥n del sistema...', 'info');
            
            try {
                // Verificar cada m√≥dulo
                const pacientes = await AppUtils.getAll('pacientes');
                document.getElementById('pacientesCount').textContent = pacientes.length;
                log(`‚úÖ Pacientes: ${pacientes.length} registros cargados`, 'success');
                
                const medicos = await AppUtils.getAll('medicos');
                document.getElementById('medicosCount').textContent = medicos.length;
                log(`‚úÖ M√©dicos: ${medicos.length} registros cargados`, 'success');
                
                const citas = await AppUtils.getAll('citas');
                document.getElementById('citasCount').textContent = citas.length;
                log(`‚úÖ Citas: ${citas.length} registros cargados`, 'success');
                
                const medicamentos = await AppUtils.getAll('medicamentos');
                document.getElementById('medicamentosCount').textContent = medicamentos.length;
                log(`‚úÖ Medicamentos: ${medicamentos.length} registros cargados`, 'success');
                
                // Mostrar resultados
                document.getElementById('systemStatus').innerHTML = 
                    '<div class="alert alert-success"><strong>üéâ Sistema funcionando correctamente!</strong> Todos los m√≥dulos est√°n operativos.</div>';
                document.getElementById('testResults').style.display = 'block';
                
                log('üéØ Sistema verificado exitosamente - Listo para uso', 'success');
                
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 
                    `<div class="alert alert-danger"><strong>‚ùå Error en el sistema:</strong> ${error.message}</div>`;
                log(`‚ùå Error durante la verificaci√≥n: ${error.message}`, 'error');
            }
            
            // Configurar botones de prueba
            setupTestButtons();
        });
        
        function setupTestButtons() {
            // Test crear paciente
            document.getElementById('testCreatePaciente').addEventListener('click', async function() {
                try {
                    log('üìù Creando paciente de prueba...', 'info');
                    const newPaciente = {
                        nombres: 'Test',
                        apellidos: 'Usuario',
                        fechaNacimiento: '1990-01-01',
                        genero: 'MASCULINO',
                        telefono: '555-TEST',
                        email: 'test@email.com',
                        direccion: 'Direcci√≥n de prueba',
                        contactoEmergencia: 'Contacto Test',
                        telefonoEmergencia: '555-EMERG',
                        tipoSangre: 'O+',
                        alergias: 'Ninguna',
                        seguroMedico: 'Test Seguro',
                        numeroIdentificacion: '12345TEST',
                        estadoCivil: 'Soltero',
                        ocupacion: 'Prueba'
                    };
                    
                    const result = await AppUtils.create('pacientes', newPaciente);
                    log(`‚úÖ Paciente creado exitosamente con ID: ${result.id}`, 'success');
                    
                    // Actualizar contador
                    const pacientes = await AppUtils.getAll('pacientes');
                    document.getElementById('pacientesCount').textContent = pacientes.length;
                    
                } catch (error) {
                    log(`‚ùå Error al crear paciente: ${error.message}`, 'error');
                }
            });
            
            // Test crear medicamento
            document.getElementById('testCreateMedicamento').addEventListener('click', async function() {
                try {
                    log('üíä Creando medicamento de prueba...', 'info');
                    const newMedicamento = {
                        nombre: 'Test Medicine',
                        descripcion: 'Medicamento de prueba',
                        codigo: 'TEST001',
                        fabricante: 'Test Pharma',
                        categoria: 'Pruebas',
                        precio: 10.0,
                        stock: 100,
                        stockMinimo: 10,
                        requiereReceta: false
                    };
                    
                    const result = await AppUtils.create('medicamentos', newMedicamento);
                    log(`‚úÖ Medicamento creado exitosamente con ID: ${result.id}`, 'success');
                    
                    // Actualizar contador
                    const medicamentos = await AppUtils.getAll('medicamentos');
                    document.getElementById('medicamentosCount').textContent = medicamentos.length;
                    
                } catch (error) {
                    log(`‚ùå Error al crear medicamento: ${error.message}`, 'error');
                }
            });
        }
    </script>
</body>
</html>
