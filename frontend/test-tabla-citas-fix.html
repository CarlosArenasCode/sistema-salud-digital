<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tabla Citas - Despu√©s del Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="alert alert-info">
            <h4><i class="fas fa-info-circle"></i> Test de Correcci√≥n de Tabla de Citas</h4>
            <p>Esta p√°gina prueba que las columnas de la tabla ahora muestren los datos correctos despu√©s del fix en CRUDManager.</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> Tabla de Citas Corregida</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Paciente</th>
                                <th>M√©dico</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="citasTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="alert alert-success" id="statusOk" style="display:none;">
                <h6><i class="fas fa-check-circle"></i> ‚úÖ Tabla funcionando correctamente</h6>
                <p>Los datos se muestran en las columnas correctas.</p>
            </div>
            <div class="alert alert-danger" id="statusError" style="display:none;">
                <h6><i class="fas fa-exclamation-triangle"></i> ‚ùå Error detectado</h6>
                <p id="errorMessage"></p>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/crud-manager.js"></script>
    <script>
        // Variables globales
        let pacientesData = [];
        let medicosData = [];
        
        // Configuraci√≥n de citas (igual que la original)
        const citaConfig = {
            entityName: 'cita',
            entityNamePlural: 'citas',
            apiEndpoint: '/api/citas',
            modalId: 'citaModal',
            formId: 'citaForm',
            tableBodyId: 'citasTableBody',
            fields: [
                { name: 'idPaciente', type: 'select', required: true },
                { name: 'idMedico', type: 'select', required: true },
                { name: 'fechaCita', type: 'date', required: true },
                { name: 'horaCita', type: 'time', required: true },
                { name: 'motivoConsulta', type: 'textarea' },
                { name: 'estado', type: 'select' },
                { name: 'observaciones', type: 'textarea' }
            ],
            formatTableRow: function(cita) {
                const estadoClass = {
                    'PROGRAMADA': 'bg-warning',
                    'CONFIRMADA': 'bg-info',
                    'EN_CURSO': 'bg-primary',
                    'COMPLETADA': 'bg-success',
                    'CANCELADA': 'bg-danger',
                    'NO_ASISTIO': 'bg-secondary'
                };

                // Buscar nombre del paciente
                const paciente = pacientesData.find(p => p.id === cita.idPaciente);
                const nombrePaciente = paciente ? `${paciente.nombres} ${paciente.apellidos}` : `ID: ${cita.idPaciente}`;

                // Buscar nombre del m√©dico
                const medico = medicosData.find(m => m.id === cita.idMedico);
                const nombreMedico = medico ? `${medico.nombres} ${medico.apellidos}` : `ID: ${cita.idMedico}`;

                // Separar fecha y hora del fechaCita
                let fecha = 'N/A';
                let hora = 'N/A';
                if (cita.fechaCita) {
                    const fechaHora = new Date(cita.fechaCita);
                    fecha = fechaHora.toLocaleDateString('es-ES');
                    hora = fechaHora.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
                }

                return `
                    <tr>
                        <td>${cita.id}</td>
                        <td>${nombrePaciente}</td>
                        <td>${nombreMedico}</td>
                        <td>${fecha}</td>
                        <td>${hora}</td>
                        <td><span class="badge ${estadoClass[cita.estado] || 'bg-secondary'}">${cita.estado || 'N/A'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
        };
        
        // Crear manager de citas
        const citaManager = new CRUDManager(citaConfig);
        
        // Funci√≥n para cargar datos de pacientes y m√©dicos
        async function loadRequiredData() {
            try {
                console.log('üîÑ Cargando datos requeridos...');
                
                // Cargar pacientes
                pacientesData = await AppUtils.getAll('pacientes');
                console.log('‚úÖ Pacientes cargados:', pacientesData.length);
                
                // Cargar m√©dicos
                medicosData = await AppUtils.getAll('medicos');
                console.log('‚úÖ M√©dicos cargados:', medicosData.length);
                
                // Ahora cargar citas (esto usar√° la funci√≥n formatTableRow personalizada)
                await citaManager.loadData();
                
                // Verificar que la tabla se haya llenado correctamente
                const rows = document.querySelectorAll('#citasTableBody tr');
                if (rows.length > 0) {
                    document.getElementById('statusOk').style.display = 'block';
                    console.log('‚úÖ Tabla cargada exitosamente con', rows.length, 'citas');
                } else {
                    throw new Error('No se cargaron citas en la tabla');
                }
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('statusError').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }
        
        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando test de tabla de citas...');
            loadRequiredData();
        });
    </script>
</body>
</html>
