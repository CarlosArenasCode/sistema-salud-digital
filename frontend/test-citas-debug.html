<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Formulario de Citas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test - Formulario de Citas Completo</h2>
        <div id="status" class="alert alert-info">Inicializando...</div>
        
        <!-- Bot√≥n para abrir modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#testCitaModal">
            Abrir Formulario de Cita
        </button>
        
        <!-- Modal igual al del m√≥dulo de citas -->
        <div class="modal fade" id="testCitaModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nueva Cita</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="testCitaForm">
                            <div class="mb-3">
                                <label for="idPaciente" class="form-label">Paciente *</label>
                                <select class="form-select" id="idPaciente" required>
                                    <option value="">Seleccione un paciente</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="idMedico" class="form-label">M√©dico *</label>
                                <select class="form-select" id="idMedico" required>
                                    <option value="">Seleccione un m√©dico</option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="fechaCita" class="form-label">Fecha *</label>
                                        <input type="date" class="form-control" id="fechaCita" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="horaCita" class="form-label">Hora *</label>
                                        <input type="time" class="form-control" id="horaCita" required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="motivoConsulta" class="form-label">Motivo de la Consulta</label>
                                <textarea class="form-control" id="motivoConsulta" rows="3"></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="estado" class="form-label">Estado</label>
                                <select class="form-select" id="estado">
                                    <option value="PROGRAMADA">Programada</option>
                                    <option value="CONFIRMADA">Confirmada</option>
                                    <option value="EN_CURSO">En Curso</option>
                                    <option value="COMPLETADA">Completada</option>
                                    <option value="CANCELADA">Cancelada</option>
                                    <option value="NO_ASISTIO">No Asisti√≥</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="testSaveBtn">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h4>Log de Depuraci√≥n:</h4>
            <div id="debugLog" class="border p-3" style="background-color: #f8f9fa; height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let debugLog = [];
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            document.getElementById('debugLog').innerHTML = debugLog.join('<br>');
            console.log(message);
        }
        
        async function loadSelectOptions() {
            const statusDiv = document.getElementById('status');
            
            try {
                addLog('üîÑ Iniciando carga de opciones...');
                statusDiv.textContent = 'Cargando pacientes...';
                
                // Cargar pacientes
                addLog('üìû Llamando a AppUtils.get("/api/pacientes")...');
                const pacientes = await AppUtils.get('/api/pacientes');
                addLog(`‚úÖ Pacientes recibidos: ${pacientes.length} registros`);
                
                const pacienteSelect = document.getElementById('idPaciente');
                if (!pacienteSelect) {
                    addLog('‚ùå ERROR: No se encontr√≥ el elemento #idPaciente');
                    return;
                }
                
                addLog('üîÑ Limpiando opciones de pacientes...');
                pacienteSelect.innerHTML = '<option value="">Seleccione un paciente</option>';
                
                addLog('üîÑ Agregando opciones de pacientes...');
                pacientes.forEach((paciente, index) => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = `${paciente.nombres} ${paciente.apellidos}`;
                    pacienteSelect.appendChild(option);
                    addLog(`  ‚ûï Paciente ${index + 1}: ${paciente.nombres} ${paciente.apellidos} (ID: ${paciente.id})`);
                });
                
                statusDiv.textContent = 'Cargando m√©dicos...';
                
                // Cargar m√©dicos
                addLog('üìû Llamando a AppUtils.get("/api/medicos")...');
                const medicos = await AppUtils.get('/api/medicos');
                addLog(`‚úÖ M√©dicos recibidos: ${medicos.length} registros`);
                
                const medicoSelect = document.getElementById('idMedico');
                if (!medicoSelect) {
                    addLog('‚ùå ERROR: No se encontr√≥ el elemento #idMedico');
                    return;
                }
                
                addLog('üîÑ Limpiando opciones de m√©dicos...');
                medicoSelect.innerHTML = '<option value="">Seleccione un m√©dico</option>';
                
                addLog('üîÑ Agregando opciones de m√©dicos...');
                medicos.forEach((medico, index) => {
                    const option = document.createElement('option');
                    option.value = medico.id;
                    option.textContent = `${medico.nombres} ${medico.apellidos} - ${medico.especializacion}`;
                    medicoSelect.appendChild(option);
                    addLog(`  ‚ûï M√©dico ${index + 1}: ${medico.nombres} ${medico.apellidos} - ${medico.especializacion} (ID: ${medico.id})`);
                });
                
                statusDiv.className = 'alert alert-success';
                statusDiv.textContent = '‚úÖ Opciones cargadas exitosamente!';
                addLog('üéâ √âXITO: Todas las opciones han sido cargadas correctamente');
                
            } catch (error) {
                addLog(`‚ùå ERROR: ${error.message}`);
                console.error('Error loading select options:', error);
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        // Simular la funcionalidad de guardar
        document.getElementById('testSaveBtn').addEventListener('click', function() {
            const pacienteId = document.getElementById('idPaciente').value;
            const medicoId = document.getElementById('idMedico').value;
            const fecha = document.getElementById('fechaCita').value;
            const hora = document.getElementById('horaCita').value;
            
            addLog(`üìù Datos del formulario:`);
            addLog(`  - Paciente ID: ${pacienteId || 'NO SELECCIONADO'}`);
            addLog(`  - M√©dico ID: ${medicoId || 'NO SELECCIONADO'}`);
            addLog(`  - Fecha: ${fecha || 'NO ESPECIFICADA'}`);
            addLog(`  - Hora: ${hora || 'NO ESPECIFICADA'}`);
            
            if (!pacienteId || !medicoId) {
                addLog('‚ö†Ô∏è ADVERTENCIA: Faltan datos requeridos');
                alert('Por favor seleccione paciente y m√©dico');
            } else {
                addLog('‚úÖ Formulario v√°lido para env√≠o');
            }
        });
        
        // Cargar opciones cuando se abre el modal
        document.getElementById('testCitaModal').addEventListener('show.bs.modal', function() {
            addLog('ü™ü Modal abierto - Cargando opciones...');
            loadSelectOptions();
        });
        
        // Inicializar cuando carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ P√°gina cargada - Sistema inicializado');
        });
    </script>
</body>
</html>
