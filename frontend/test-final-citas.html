<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Test Final - Formulario de Citas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1 class="display-4">ü©∫ Test Formulario de Citas</h1>
                <p class="lead">Verificaci√≥n completa de selectores de pacientes y m√©dicos</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-database"></i> Estado de Datos</h5>
                    </div>
                    <div class="card-body">
                        <div id="dataStatus">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <span>Cargando datos...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-calendar-plus"></i> Formulario de Nueva Cita</h5>
                    </div>
                    <div class="card-body">
                        <form id="testCitaForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testIdPaciente" class="form-label">üë§ Paciente *</label>
                                        <select class="form-select" id="testIdPaciente" required>
                                            <option value="">üîÑ Cargando pacientes...</option>
                                        </select>
                                        <div class="form-text">
                                            Estado: <span id="pacienteSelectStatus" class="text-warning">Cargando...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testIdMedico" class="form-label">üë®‚Äç‚öïÔ∏è M√©dico *</label>
                                        <select class="form-select" id="testIdMedico" required>
                                            <option value="">üîÑ Cargando m√©dicos...</option>
                                        </select>
                                        <div class="form-text">
                                            Estado: <span id="medicoSelectStatus" class="text-warning">Cargando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testFechaCita" class="form-label">üìÖ Fecha *</label>
                                        <input type="date" class="form-control" id="testFechaCita" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testHoraCita" class="form-label">üïê Hora *</label>
                                        <input type="time" class="form-control" id="testHoraCita" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="testMotivoConsulta" class="form-label">üìù Motivo de la Consulta</label>
                                <textarea class="form-control" id="testMotivoConsulta" rows="3" placeholder="Describe el motivo de la consulta"></textarea>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success" onclick="testFormSubmission()">
                                    <i class="fas fa-check"></i> Probar Env√≠o
                                </button>
                                <button type="button" class="btn btn-info" onclick="reloadData()">
                                    <i class="fas fa-sync"></i> Recargar Datos
                                </button>
                                <button type="button" class="btn btn-primary" onclick="window.open('citas-optimized.html', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Abrir M√≥dulo Real
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Datos Disponibles</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">üë• Pacientes Disponibles:</h6>
                                <div id="pacientesDisponibles" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <em class="text-muted">Cargando pacientes...</em>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">üë®‚Äç‚öïÔ∏è M√©dicos Disponibles:</h6>
                                <div id="medicosDisponibles" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <em class="text-muted">Cargando m√©dicos...</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bug"></i> Log de Actividad</h5>
                    </div>
                    <div class="card-body">
                        <div id="activityLog" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                            <!-- Los logs aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let pacientesData = [];
        let medicosData = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-primary',
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning'
            };
            
            const logElement = document.getElementById('activityLog');
            const logEntry = `
                <div class="${colors[type] || 'text-dark'}">
                    [${timestamp}] ${message}
                </div>
            `;
            logElement.innerHTML += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        async function loadData() {
            try {
                log('üöÄ Iniciando carga de datos del sistema...', 'info');
                
                // Actualizar estado visual
                document.getElementById('dataStatus').innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>Cargando pacientes...</span>
                    </div>
                `;
                
                // Cargar pacientes
                log('üì• Solicitando datos de pacientes...', 'info');
                pacientesData = await AppUtils.getAll('pacientes');
                log(`‚úÖ Pacientes cargados exitosamente: ${pacientesData.length} registros`, 'success');
                
                // Actualizar estado
                document.getElementById('dataStatus').innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>Cargando m√©dicos...</span>
                    </div>
                `;
                
                // Cargar m√©dicos
                log('üì• Solicitando datos de m√©dicos...', 'info');
                medicosData = await AppUtils.getAll('medicos');
                log(`‚úÖ M√©dicos cargados exitosamente: ${medicosData.length} registros`, 'success');
                
                // Actualizar selectores
                populateSelectors();
                updateDataDisplay();
                updateStatus();
                
                log('üéâ Todos los datos cargados correctamente', 'success');
                
            } catch (error) {
                log(`‚ùå Error durante la carga: ${error.message}`, 'error');
                updateErrorStatus(error.message);
            }
        }
        
        function populateSelectors() {
            log('üîÑ Llenando selectores con datos...', 'info');
            
            // Llenar selector de pacientes
            const pacienteSelect = document.getElementById('testIdPaciente');
            pacienteSelect.innerHTML = '<option value="">Seleccione un paciente</option>';
            
            if (pacientesData.length > 0) {
                pacientesData.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = `${paciente.nombres} ${paciente.apellidos}`;
                    pacienteSelect.appendChild(option);
                });
                document.getElementById('pacienteSelectStatus').innerHTML = `<span class="text-success">‚úÖ ${pacientesData.length} opciones</span>`;
                log(`‚úÖ Selector de pacientes llenado con ${pacientesData.length} opciones`, 'success');
            } else {
                document.getElementById('pacienteSelectStatus').innerHTML = '<span class="text-warning">‚ö†Ô∏è Sin datos</span>';
            }
            
            // Llenar selector de m√©dicos
            const medicoSelect = document.getElementById('testIdMedico');
            medicoSelect.innerHTML = '<option value="">Seleccione un m√©dico</option>';
            
            if (medicosData.length > 0) {
                medicosData.forEach(medico => {
                    const option = document.createElement('option');
                    option.value = medico.id;
                    option.textContent = `${medico.nombres} ${medico.apellidos} - ${medico.especializacion}`;
                    medicoSelect.appendChild(option);
                });
                document.getElementById('medicoSelectStatus').innerHTML = `<span class="text-success">‚úÖ ${medicosData.length} opciones</span>`;
                log(`‚úÖ Selector de m√©dicos llenado con ${medicosData.length} opciones`, 'success');
            } else {
                document.getElementById('medicoSelectStatus').innerHTML = '<span class="text-warning">‚ö†Ô∏è Sin datos</span>';
            }
        }
        
        function updateDataDisplay() {
            // Mostrar pacientes disponibles
            const pacientesDiv = document.getElementById('pacientesDisponibles');
            if (pacientesData.length > 0) {
                pacientesDiv.innerHTML = pacientesData.map(p => 
                    `<div class="mb-1">
                        <strong>ID ${p.id}:</strong> ${p.nombres} ${p.apellidos}
                        <small class="text-muted">${p.email || 'Sin email'}</small>
                    </div>`
                ).join('');
            } else {
                pacientesDiv.innerHTML = '<em class="text-muted">No hay pacientes disponibles</em>';
            }
            
            // Mostrar m√©dicos disponibles
            const medicosDiv = document.getElementById('medicosDisponibles');
            if (medicosData.length > 0) {
                medicosDiv.innerHTML = medicosData.map(m => 
                    `<div class="mb-1">
                        <strong>ID ${m.id}:</strong> ${m.nombres} ${m.apellidos}
                        <small class="text-muted">${m.especializacion}</small>
                    </div>`
                ).join('');
            } else {
                medicosDiv.innerHTML = '<em class="text-muted">No hay m√©dicos disponibles</em>';
            }
        }
        
        function updateStatus() {
            const statusDiv = document.getElementById('dataStatus');
            const totalRecords = pacientesData.length + medicosData.length;
            
            statusDiv.innerHTML = `
                <div class="text-center">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-primary">
                                <i class="fas fa-users fs-4"></i>
                                <div><strong>${pacientesData.length}</strong></div>
                                <small>Pacientes</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-success">
                                <i class="fas fa-user-md fs-4"></i>
                                <div><strong>${medicosData.length}</strong></div>
                                <small>M√©dicos</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <span class="badge bg-success">‚úÖ Sistema Operativo</span>
                    </div>
                </div>
            `;
        }
        
        function updateErrorStatus(error) {
            document.getElementById('dataStatus').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-danger fs-4"></i>
                    <div class="mt-2">
                        <span class="badge bg-danger">‚ùå Error</span>
                        <small class="d-block text-muted mt-1">${error}</small>
                    </div>
                </div>
            `;
        }
        
        function testFormSubmission() {
            const pacienteId = document.getElementById('testIdPaciente').value;
            const medicoId = document.getElementById('testIdMedico').value;
            const fecha = document.getElementById('testFechaCita').value;
            const hora = document.getElementById('testHoraCita').value;
            const motivo = document.getElementById('testMotivoConsulta').value;
            
            if (!pacienteId || !medicoId || !fecha || !hora) {
                log('‚ö†Ô∏è Faltan campos obligatorios en el formulario', 'warning');
                alert('Por favor complete todos los campos obligatorios');
                return;
            }
            
            const paciente = pacientesData.find(p => p.id == pacienteId);
            const medico = medicosData.find(m => m.id == medicoId);
            
            log('üìã Simulando env√≠o de formulario...', 'info');
            log(`üë§ Paciente seleccionado: ${paciente.nombres} ${paciente.apellidos}`, 'info');
            log(`üë®‚Äç‚öïÔ∏è M√©dico seleccionado: ${medico.nombres} ${medico.apellidos} (${medico.especializacion})`, 'info');
            log(`üìÖ Fecha y hora: ${fecha} ${hora}`, 'info');
            log(`üìù Motivo: ${motivo || 'No especificado'}`, 'info');
            log('‚úÖ Simulaci√≥n exitosa - Los selectores est√°n funcionando correctamente', 'success');
            
            alert('‚úÖ ¬°Test exitoso! Los selectores est√°n funcionando correctamente.');
        }
        
        function reloadData() {
            log('üîÑ Recargando datos...', 'info');
            document.getElementById('activityLog').innerHTML = '';
            loadData();
        }
        
        // Establecer fecha m√≠nima como hoy
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('testFechaCita').min = today;
            document.getElementById('testFechaCita').value = today;
            
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                               now.getMinutes().toString().padStart(2, '0');
            document.getElementById('testHoraCita').value = currentTime;
        }
        
        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Iniciando aplicaci√≥n de test...', 'info');
            setMinDate();
            loadData();
        });
    </script>
</body>
</html>
