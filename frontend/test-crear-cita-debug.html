<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Crear Cita - Debug Error</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="alert alert-info">
            <h4><i class="fas fa-bug"></i> Debug: Error al Guardar Cita</h4>
            <p>Esta p√°gina prueba espec√≠ficamente la funcionalidad de crear citas para identificar el error.</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Crear Nueva Cita</h5>
            </div>
            <div class="card-body">
                <form id="testForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="idPaciente" class="form-label">Paciente *</label>
                                <select class="form-select" id="idPaciente" required>
                                    <option value="">Seleccione un paciente</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="idMedico" class="form-label">M√©dico *</label>
                                <select class="form-select" id="idMedico" required>
                                    <option value="">Seleccione un m√©dico</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fechaCita" class="form-label">Fecha *</label>
                                <input type="date" class="form-control" id="fechaCita" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horaCita" class="form-label">Hora *</label>
                                <input type="time" class="form-control" id="horaCita" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="motivoConsulta" class="form-label">Motivo de la Consulta</label>
                        <textarea class="form-control" id="motivoConsulta" rows="3" placeholder="Describe el motivo de la consulta"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-select" id="estado">
                            <option value="PROGRAMADA" selected>Programada</option>
                            <option value="CONFIRMADA">Confirmada</option>
                            <option value="EN_CURSO">En Curso</option>
                            <option value="COMPLETADA">Completada</option>
                            <option value="CANCELADA">Cancelada</option>
                            <option value="NO_ASISTIO">No Asisti√≥</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" rows="2" placeholder="Observaciones adicionales"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cita
                    </button>
                </form>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="card">
                <div class="card-header">
                    <h6>Debug Info</h6>
                </div>
                <div class="card-body">
                    <div id="debugInfo" style="font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        function log(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.textContent += `[${timestamp}] ${message}\n`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message);
        }
        
        async function loadSelectOptions() {
            try {
                log('üîÑ Cargando pacientes...');
                const pacientes = await AppUtils.getAll('pacientes');
                log(`‚úÖ Pacientes cargados: ${pacientes.length}`);
                
                const pacienteSelect = document.getElementById('idPaciente');
                pacientes.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = `${paciente.nombres} ${paciente.apellidos}`;
                    pacienteSelect.appendChild(option);
                });
                
                log('üîÑ Cargando m√©dicos...');
                const medicos = await AppUtils.getAll('medicos');
                log(`‚úÖ M√©dicos cargados: ${medicos.length}`);
                
                const medicoSelect = document.getElementById('idMedico');
                medicos.forEach(medico => {
                    const option = document.createElement('option');
                    option.value = medico.id;
                    option.textContent = `${medico.nombres} ${medico.apellidos} - ${medico.especializacion}`;
                    medicoSelect.appendChild(option);
                });
                
                log('‚úÖ Opciones cargadas correctamente');
                
            } catch (error) {
                log(`‚ùå Error cargando opciones: ${error.message}`);
            }
        }
        
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                log('üîÑ Preparando datos de la cita...');
                
                // Recopilar datos del formulario
                const fechaCita = document.getElementById('fechaCita').value;
                const horaCita = document.getElementById('horaCita').value;
                
                if (!fechaCita || !horaCita) {
                    throw new Error('Fecha y hora son obligatorias');
                }
                
                // Combinar fecha y hora
                const fechaHoraCompleta = `${fechaCita}T${horaCita}:00`;
                
                const formData = {
                    idPaciente: parseInt(document.getElementById('idPaciente').value),
                    idMedico: parseInt(document.getElementById('idMedico').value),
                    fechaCita: fechaHoraCompleta,
                    motivoConsulta: document.getElementById('motivoConsulta').value || null,
                    estado: document.getElementById('estado').value,
                    observaciones: document.getElementById('observaciones').value || null
                };
                
                log('üìã Datos a enviar:');
                log(JSON.stringify(formData, null, 2));
                
                log('üîÑ Enviando solicitud al servidor...');
                const result = await AppUtils.create('citas', formData);
                
                log('‚úÖ Cita creada exitosamente:');
                log(JSON.stringify(result, null, 2));
                
                // Limpiar formulario
                document.getElementById('testForm').reset();
                document.getElementById('estado').value = 'PROGRAMADA';
                
                alert('‚úÖ Cita guardada exitosamente!');
                
            } catch (error) {
                log(`‚ùå ERROR al crear cita: ${error.message}`);
                
                if (error.response) {
                    log('üìÑ Respuesta del servidor:');
                    try {
                        const errorData = await error.response.json();
                        log(JSON.stringify(errorData, null, 2));
                    } catch {
                        log(`Status: ${error.response.status} ${error.response.statusText}`);
                    }
                }
                
                alert(`‚ùå Error al guardar cita: ${error.message}`);
            }
        });
        
        // Establecer fecha m√≠nima (hoy)
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaCita').min = today;
            document.getElementById('fechaCita').value = today;
            document.getElementById('horaCita').value = '09:00';
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Iniciando test de crear cita...');
            setMinDate();
            loadSelectOptions();
        });
    </script>
</body>
</html>
