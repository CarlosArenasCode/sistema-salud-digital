<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Simple - Crear Cita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="alert alert-info">
            <h4>üîß Debug Simple - Crear Cita</h4>
            <p>Test m√≠nimo para identificar el problema exacto al guardar citas.</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Formulario Simple</h5>
            </div>
            <div class="card-body">
                <form id="simpleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="idPaciente" class="form-label">Paciente *</label>
                            <select class="form-select" id="idPaciente" required>
                                <option value="">Seleccione un paciente</option>
                                <option value="3">Paciente 3</option>
                                <option value="4">Paciente 4</option>
                                <option value="5">Paciente 5</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="idMedico" class="form-label">M√©dico *</label>
                            <select class="form-select" id="idMedico" required>
                                <option value="">Seleccione un m√©dico</option>
                                <option value="1">M√©dico 1</option>
                                <option value="2">M√©dico 2</option>
                                <option value="3">M√©dico 3</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="fechaCita" class="form-label">Fecha *</label>
                            <input type="date" class="form-control" id="fechaCita" required>
                        </div>
                        <div class="col-md-6">
                            <label for="horaCita" class="form-label">Hora *</label>
                            <input type="time" class="form-control" id="horaCita" required>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label for="motivoConsulta" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivoConsulta" value="Test simple">
                    </div>
                    
                    <div class="mt-3">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-select" id="estado">
                            <option value="PROGRAMADA" selected>Programada</option>
                        </select>
                    </div>
                    
                    <div class="mt-4">
                        <button type="button" class="btn btn-primary" id="btnGuardar">
                            Guardar Cita Simple
                        </button>
                        <button type="button" class="btn btn-success" id="btnPruebaDirect">
                            Prueba Directa API
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h6>Estado y Resultados</h6>
                </div>
                <div class="card-body">
                    <div id="resultado"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        function mostrarResultado(mensaje, tipo = 'info') {
            const div = document.getElementById('resultado');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[tipo] || 'alert-info';
            
            div.innerHTML = `<div class="alert ${alertClass}">${mensaje}</div>`;
            console.log(`[${tipo.toUpperCase()}]`, mensaje);
        }
        
        // Bot√≥n de prueba directa de API
        document.getElementById('btnPruebaDirect').addEventListener('click', async function() {
            mostrarResultado('üîÑ Probando API directamente...', 'info');
            
            try {
                const testData = {
                    idPaciente: 3,
                    idMedico: 1,
                    fechaCita: "2025-06-11T10:00:00",
                    motivoConsulta: "Test directo API",
                    estado: "PROGRAMADA",
                    observaciones: null
                };
                
                console.log('Enviando datos:', testData);
                const result = await AppUtils.create('citas', testData);
                console.log('Resultado:', result);
                
                mostrarResultado(`‚úÖ API funciona correctamente. Cita creada con ID: ${result.id}`, 'success');
                
            } catch (error) {
                console.error('Error API directa:', error);
                mostrarResultado(`‚ùå Error en API directa: ${error.message}`, 'error');
            }
        });
        
        // Bot√≥n de guardar usando formulario
        document.getElementById('btnGuardar').addEventListener('click', async function() {
            mostrarResultado('üîÑ Guardando desde formulario...', 'info');
            
            try {
                // Recopilar datos del formulario
                const formData = {
                    idPaciente: parseInt(document.getElementById('idPaciente').value),
                    idMedico: parseInt(document.getElementById('idMedico').value),
                    fechaCita: document.getElementById('fechaCita').value,
                    horaCita: document.getElementById('horaCita').value,
                    motivoConsulta: document.getElementById('motivoConsulta').value,
                    estado: document.getElementById('estado').value,
                    observaciones: null
                };
                
                console.log('Datos del formulario (raw):', formData);
                
                // Validar
                if (!formData.idPaciente || !formData.idMedico || !formData.fechaCita || !formData.horaCita) {
                    throw new Error('Faltan campos obligatorios');
                }
                
                // Combinar fecha y hora
                formData.fechaCita = `${formData.fechaCita}T${formData.horaCita}:00`;
                delete formData.horaCita;
                
                console.log('Datos procesados:', formData);
                
                const result = await AppUtils.create('citas', formData);
                console.log('Resultado:', result);
                
                mostrarResultado(`‚úÖ Cita guardada exitosamente. ID: ${result.id}`, 'success');
                
                // Limpiar formulario
                document.getElementById('simpleForm').reset();
                
            } catch (error) {
                console.error('Error guardando desde formulario:', error);
                mostrarResultado(`‚ùå Error guardando desde formulario: ${error.message}`, 'error');
            }
        });
        
        // Establecer valores por defecto
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaCita').value = today;
            document.getElementById('fechaCita').min = today;
            document.getElementById('horaCita').value = '10:00';
            document.getElementById('idPaciente').value = '3';
            document.getElementById('idMedico').value = '1';
            
            mostrarResultado('‚úÖ Formulario inicializado con valores por defecto', 'info');
        });
    </script>
</body>
</html>
